<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Market Pro | لوحة التحكم والسوق</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        :root { 
            --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #f59e0b;
            --dark: #1e293b; --text: #0f172a; --text-light: #64748b;
            --bg: #f1f5f9; --white: #ffffff; --border: #e2e8f0;
            --success: #10b981; --danger: #ef4444;
        }
        
        body { background: var(--bg); color: var(--text); line-height: 1.6; padding-bottom: 80px; }
        
        /* Loading & UI */
        .loading { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; transition: 0.5s; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        
        .main-header { background: var(--primary); padding: 16px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .logo { color: white; text-decoration: none; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        
        .search-box { flex: 1; display: flex; background: white; border-radius: 8px; overflow: hidden; }
        .search-box input { flex: 1; border: none; padding: 10px; outline: none; }
        .search-box button { background: var(--secondary); border: none; padding: 0 15px; color: white; }
        
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        
        /* Category Tabs */
        .category-tabs { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .cat-tab { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .cat-tab.active { background: white; color: var(--primary); font-weight: bold; }

        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 1px solid var(--border); transition: 0.3s; }
        .product-image { height: 150px; background: #eee; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 10px; }
        .product-price { color: var(--primary); font-size: 16px; font-weight: 800; }
        .product-title { font-size: 13px; font-weight: 600; margin: 4px 0; height: 38px; overflow: hidden; }
        
        /* Admin Delete Button */
        .del-btn { position: absolute; top: 8px; right: 8px; background: var(--danger); color: white; border: none; padding: 6px 8px; border-radius: 6px; cursor: pointer; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 15px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 450px; border-radius: 20px; overflow: hidden; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; max-height: 80vh; overflow-y: auto; }

        .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-whatsapp { background: #25D366; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 20px; border-radius: 50px; z-index: 3000; display: none; }
        
        .bottom-nav { position: fixed; bottom: 0; inset-x: 0; background: white; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); }
        .nav-item { color: var(--text-light); text-decoration: none; font-size: 11px; text-align: center; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="loading" id="loading"><i class="fas fa-spinner fa-spin fa-3x"></i></div>

    <header class="main-header">
        <div class="header-top">
            <a href="#" class="logo"><i class="fas fa-globe"></i> Global Pro</a>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ابحث عن منتج..." onkeyup="searchProducts(this.value)">
                <button><i class="fas fa-search"></i></button>
            </div>
            <div id="authArea">
                <button onclick="showAuthModal()" id="signInBtn" class="cat-tab" style="background: var(--secondary)">دخول</button>
                <img id="userAvatar" class="user-avatar hidden" onclick="logout()">
            </div>
        </div>
        <div class="category-tabs" id="catTabs">
            <button class="cat-tab active" onclick="filterCat('all', this)">الكل</button>
            <button class="cat-tab" onclick="filterCat('electronics', this)">إلكترونيات</button>
            <button class="cat-tab" onclick="filterCat('fashion', this)">أزياء</button>
            <button class="cat-tab" onclick="filterCat('home', this)">منزل</button>
        </div>
    </header>

    <div class="products-grid" id="productsDisplay"></div>

    <div class="modal-overlay" id="detailModal" onclick="closeM(event, 'detailModal')">
        <div class="modal" id="detailContent"></div>
    </div>

    <div class="modal-overlay" id="addModal" onclick="closeM(event, 'addModal')">
        <div class="modal">
            <div class="modal-header"><h3>إضافة منتج جديد</h3><button onclick="closeM(null, 'addModal')" style="background:none; border:none; color:white; font-size:20px;">&times;</button></div>
            <div class="modal-body">
                <form onsubmit="handleUpload(event)">
                    <input type="text" id="pN" placeholder="اسم المنتج" required style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                    <input type="number" id="pP" placeholder="السعر ($)" required style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                    <input type="number" id="pM" placeholder="أقل كمية طلب (MOQ)" required style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                    <select id="pC" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                        <option value="electronics">إلكترونيات</option>
                        <option value="fashion">أزياء</option>
                        <option value="home">منزل</option>
                    </select>
                    <textarea id="pD" placeholder="وصف المنتج" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    <input type="file" id="pI" accept="image/*" style="margin-bottom:15px;">
                    <button type="submit" id="upBtn" class="btn-primary">نشر المنتج</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="authModal" onclick="closeM(event, 'authModal')">
        <div class="modal" style="text-align:center; padding:30px;">
            <h3>تسجيل الدخول</h3>
            <p style="margin:15px 0; color:var(--text-light);">سجل دخولك لتتمكن من إضافة منتجاتك</p>
            <button onclick="googleLogin()" class="btn-primary" style="background:#4285F4;"><i class="fab fa-google"></i> عبر جوجل</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fas fa-home"></i>الرئيسية</a>
        <a href="#" onclick="showAdd()" class="nav-item"><i class="fas fa-plus-circle"></i>بيع</a>
        <a href="#" class="nav-item"><i class="fas fa-heart"></i>المفضلة</a>
    </nav>

    <script>
        // --- 1. الإعدادات والتهيئبة ---
        const ADMIN_EMAIL = "Csnap9489@gmail.com";
        const firebaseConfig = {
            apiKey: "AIzaSyB650D7BDg0f4q7cf9kndvKW5Qz8H1nFj0",
            authDomain: "mymarket-ec08e.firebaseapp.com",
            projectId: "mymarket-ec08e",
            storageBucket: "mymarket-ec08e.firebasestorage.app",
            messagingSenderId: "529357774752",
            appId: "1:529357774752:web:1dc0b061541702e22f8ec5"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let allProducts = [];
        let user = null;

        // --- 2. إدارة المستخدم ---
        auth.onAuthStateChanged(u => {
            user = u;
            document.getElementById('loading').classList.add('hidden');
            if(u) {
                document.getElementById('signInBtn').classList.add('hidden');
                document.getElementById('userAvatar').src = u.photoURL;
                document.getElementById('userAvatar').classList.remove('hidden');
            } else {
                document.getElementById('signInBtn').classList.remove('hidden');
                document.getElementById('userAvatar').classList.add('hidden');
            }
            fetchProducts();
        });

        function googleLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(p).then(() => location.reload());
        }
        function logout() { if(confirm('تسجيل خروج؟')) auth.signOut(); }

        // --- 3. جلب وعرض البيانات ---
        function fetchProducts() {
            db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snap => {
                allProducts = [];
                snap.forEach(doc => allProducts.push({id: doc.id, ...doc.data()}));
                render(allProducts);
            });
        }

        function render(data) {
            const container = document.getElementById('productsDisplay');
            const isAdmin = user && user.email === ADMIN_EMAIL;
            
            container.innerHTML = data.map(p => `
                <div class="product-card">
                    ${isAdmin ? `<button class="del-btn" onclick="deleteProd('${p.id}', event)"><i class="fas fa-trash"></i></button>` : ''}
                    <div onclick="viewProd('${p.id}')">
                        <div class="product-image">
                            <img src="${p.imageUrl || 'https://via.placeholder.com/150'}">
                        </div>
                        <div class="product-info">
                            <div class="product-price">$${p.price}</div>
                            <div class="product-title">${p.name}</div>
                            <div style="font-size:11px; color:gray;">أقل طلب: ${p.moq}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- 4. العمليات (حذف، تفاصيل، إضافة) ---
        window.viewProd = function(id) {
            const p = allProducts.find(x => x.id === id);
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="modal-header"><h3>تفاصيل المنتج</h3><button onclick="closeM(null, 'detailModal')" style="background:none; border:none; color:white; font-size:20px;">&times;</button></div>
                <div class="modal-body" style="text-align:center;">
                    <img src="${p.imageUrl}" style="width:100%; border-radius:10px; margin-bottom:15px;">
                    <h2 style="margin-bottom:10px;">${p.name}</h2>
                    <div style="font-size:20px; color:var(--primary); font-weight:bold; margin-bottom:10px;">$${p.price}</div>
                    <p style="color:var(--text-light); font-size:14px; margin-bottom:20px;">${p.description || 'لا يوجد وصف.'}</p>
                    <a href="https://wa.me/967738520546?text=أريد طلب: ${p.name}" class="btn-primary btn-whatsapp"><i class="fab fa-whatsapp"></i> اطلب الآن عبر واتساب</a>
                </div>
            `;
            document.getElementById('detailModal').classList.add('active');
        };

        window.deleteProd = async function(id, e) {
            e.stopPropagation();
            if(confirm('حذف هذا المنتج نهائياً؟')) {
                await db.collection('products').doc(id).delete();
                toast('تم الحذف بنجاح');
            }
        };

        async function handleUpload(e) {
            e.preventDefault();
            const btn = document.getElementById('upBtn');
            btn.disabled = true; btn.innerText = "جاري الرفع...";

            let url = "";
            const file = document.getElementById('pI').files[0];
            if(file) {
                const ref = storage.ref(`products/${Date.now()}`);
                await ref.put(file);
                url = await ref.getDownloadURL();
            }

            await db.collection('products').add({
                name: document.getElementById('pN').value,
                price: document.getElementById('pP').value,
                moq: document.getElementById('pM').value,
                category: document.getElementById('pC').value,
                description: document.getElementById('pD').value,
                imageUrl: url,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            closeM(null, 'addModal');
            toast('تم النشر بنجاح!');
            btn.disabled = false; btn.innerText = "نشر المنتج";
        }

        // --- 5. أدوات المساعدة ---
        window.showAdd = () => user ? document.getElementById('addModal').classList.add('active') : showAuthModal();
        window.showAuthModal = () => document.getElementById('authModal').classList.add('active');
        window.closeM = (e, id) => { if(!e || e.target.classList.contains('modal-overlay')) document.getElementById(id).classList.remove('active'); };
        window.toast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(() => t.style.display='none', 3000); };
        
        window.filterCat = (c, btn) => {
            document.querySelectorAll('.cat-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(c === 'all') render(allProducts);
            else render(allProducts.filter(p => p.category === c));
        };

        window.searchProducts = (q) => render(allProducts.filter(p => p.name.toLowerCase().includes(q.toLowerCase())));
    </script>
</body>
</html>
