<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Market Pro | النسخة الاحترافية</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb; --accent: #f59e0b; --bg: #f8fafc;
            --text: #1e293b; --card: #ffffff;
        }
        body.dark-mode {
            --bg: #0f172a; --text: #f8fafc; --card: #1e293b;
        }
        
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; padding-bottom: 80px; }
        
        /* Navigation & Header */
        .header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .logo { font-weight: 800; font-size: 22px; cursor: pointer; }
        .actions { display: flex; gap: 15px; align-items: center; }

        /* Banner & Search */
        .search-area { padding: 20px; background: var(--primary); border-radius: 0 0 30px 30px; }
        .search-bar { background: white; border-radius: 12px; display: flex; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .search-bar input { border: none; flex: 1; padding: 10px; outline: none; border-radius: 10px; }

        /* Grid & Cards */
        .container { padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 160px; object-fit: cover; }
        .badge-verified { position: absolute; top: 10px; right: 10px; background: #00b8ff; color: white; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; }
        .card-content { padding: 12px; }
        .price { font-size: 18px; font-weight: 800; color: var(--primary); }
        
        /* Stats Dashboard for Admin */
        #adminStats { display: none; background: #10b981; color: white; padding: 15px; margin: 15px; border-radius: 15px; }

        /* Bottom Menu */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid rgba(0,0,0,0.1); }
        .nav-item { text-align: center; color: #94a3b8; text-decoration: none; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .btn-wa { background: #25D366; color: white; display: block; text-align: center; padding: 8px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 8px; font-size: 13px; }
        
        .hidden { display: none; }
    </style>
</head>
<body id="body">

<header class="header">
    <div class="logo">GLOBAL PRO</div>
    <div class="actions">
        <i class="fas fa-moon" onclick="toggleDarkMode()" style="cursor:pointer"></i>
        <select id="currency" onchange="convertCurrency()" style="background:none; color:white; border:1px solid white; border-radius:5px;">
            <option value="USD">USD $</option>
            <option value="SAR">SAR ر.س</option>
        </select>
    </div>
</header>

<div class="search-area">
    <div class="search-bar">
        <input type="text" placeholder="ابحث عن منتج، تاجر، أو تصنيف..." onkeyup="filterItems(this.value)">
        <button style="background:var(--accent); border:none; color:white; padding:10px 20px; border-radius:10px;"><i class="fas fa-search"></i></button>
    </div>
</div>

<div id="adminStats">
    <h4>لوحة تحكم المدير <i class="fas fa-chart-line"></i></h4>
    <div id="statContent">جاري التحميل...</div>
</div>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 id="sectionTitle">المنتجات المميزة</h3>
        <select onchange="sortData(this.value)" style="border:none; background:none; font-family:inherit;">
            <option value="new">الأحدث</option>
            <option value="low">الأقل سعراً</option>
        </select>
    </div>
    <div class="grid" id="mainGrid"></div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="location.reload()"><i class="fas fa-home fa-lg"></i><br>الرئيسية</div>
    <div class="nav-item" onclick="showAdd()"><i class="fas fa-plus-circle fa-lg"></i><br>بيع</div>
    <div class="nav-item" onclick="showCategories()"><i class="fas fa-th-large fa-lg"></i><br>أقسام</div>
    <div class="nav-item" onclick="toggleAdmin()"><i class="fas fa-user-shield fa-lg"></i><br>المدير</div>
</nav>

<script>
    const ADMIN_EMAIL = "Csnap9489@gmail.com";
    const firebaseConfig = {
        apiKey: "AIzaSyB650D7BDg0f4q7cf9kndvKW5Qz8H1nFj0",
        authDomain: "mymarket-ec08e.firebaseapp.com",
        projectId: "mymarket-ec08e",
        storageBucket: "mymarket-ec08e.firebasestorage.app",
        messagingSenderId: "529357774752",
        appId: "1:529357774752:web:1dc0b061541702e22f8ec5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let allProducts = [];

    // 1. نظام جلب البيانات المتقدم
    function loadContent() {
        db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snap => {
            allProducts = [];
            snap.forEach(doc => allProducts.push({id: doc.id, ...doc.data()}));
            render(allProducts);
            updateStats();
        });
    }

    function render(data) {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = data.map(p => `
            <div class="card">
                ${p.isVerified ? '<div class="badge-verified"><i class="fas fa-check"></i> موثوق</div>' : ''}
                <img src="${p.imageUrl || 'https://via.placeholder.com/150'}" class="card-img">
                <div class="card-content">
                    <div class="price" data-usd="${p.price}">$${p.price}</div>
                    <div style="font-size:14px; height:40px; overflow:hidden;">${p.name}</div>
                    <div style="font-size:11px; color:gray; margin-top:5px;">
                        <i class="fas fa-star" style="color:var(--accent)"></i> 4.9 (20 تقييم)
                    </div>
                    <a href="https://wa.me/967738520546?text=مهتم بـ ${p.name}" onclick="trackClick('${p.id}')" class="btn-wa">
                        <i class="fab fa-whatsapp"></i> اطلب الآن
                    </a>
                </div>
            </div>
        `).join('');
    }

    // 2. ميزة تتبع النقرات (للمدير)
    async function trackClick(id) {
        const ref = db.collection('products').doc(id);
        await ref.update({ clicks: firebase.firestore.FieldValue.increment(1) });
    }

    // 3. لوحة إحصائيات المدير
    function updateStats() {
        const totalClicks = allProducts.reduce((sum, p) => sum + (p.clicks || 0), 0);
        document.getElementById('statContent').innerHTML = `
            إجمالي نقرات التواصل: <strong>${totalClicks}</strong> نقرة<br>
            عدد التجار النشطين: <strong>${new Set(allProducts.map(p => p.sellerEmail)).size}</strong>
        `;
    }

    // 4. الوضع الليلي
    function toggleDarkMode() {
        document.getElementById('body').classList.toggle('dark-mode');
        const icon = document.querySelector('.fa-moon');
        icon.classList.toggle('fa-sun');
    }

    // 5. محول العملات (بسيط)
    function convertCurrency() {
        const curr = document.getElementById('currency').value;
        const rate = curr === 'SAR' ? 3.75 : 1;
        document.querySelectorAll('.price').forEach(el => {
            const usd = el.getAttribute('data-usd');
            el.innerText = curr === 'SAR' ? `${(usd * rate).toFixed(2)} ر.س` : `$${usd}`;
        });
    }

    function toggleAdmin() {
        const stats = document.getElementById('adminStats');
        stats.style.display = stats.style.display === 'block' ? 'none' : 'block';
    }

    function filterItems(val) {
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(val.toLowerCase()));
        render(filtered);
    }

    loadContent();
</script>
</body>
</html>
